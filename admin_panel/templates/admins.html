{% extends "base.html" %}

{% block title %}Администраторы{% endblock %}

{% block content %}
<div class="sidebar">
    <div class="brand">
        <i class="bi bi-robot"></i> User Control
    </div>
    <nav class="nav flex-column">
        <a class="nav-link" href="/dashboard">
            <i class="bi bi-speedometer2"></i> Панель управления
        </a>
        <a class="nav-link" href="/requests">
            <i class="bi bi-person-check"></i> Заявки
        </a>
        <a class="nav-link" href="/users">
            <i class="bi bi-people"></i> Пользователи
        </a>
        <a class="nav-link" href="/roles">
            <i class="bi bi-person-badge"></i> Роли
        </a>
        <a class="nav-link" href="/chats">
            <i class="bi bi-chat-dots"></i> Чаты
        </a>
        <a class="nav-link active" href="/admins">
            <i class="bi bi-shield-lock"></i> Администраторы
        </a>
        <hr style="border-color: rgba(255,255,255,0.2);">
        <a class="nav-link" href="#" onclick="logout()">
            <i class="bi bi-box-arrow-right"></i> Выход
        </a>
    </nav>
</div>

<div class="main-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2 fw-bold">Администраторы</h1>
        <div>
            <button class="btn btn-primary" onclick="openCreateModal()">
                <i class="bi bi-plus-lg"></i> Добавить администратора
            </button>
            <button class="btn btn-outline-secondary" onclick="loadAdmins()">
                <i class="bi bi-arrow-clockwise"></i> Обновить
            </button>
        </div>
    </div>
    
    <div class="alert alert-warning" role="alert">
        <i class="bi bi-exclamation-triangle"></i>
        <strong>Внимание!</strong> Управление администраторами доступно только для главного администратора (admin).
    </div>
    
    <div class="table-container">
        <div id="adminsTable">
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Загрузка...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Admin Modal -->
<div class="modal fade" id="createModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Создать администратора</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createForm">
                    <div class="mb-3">
                        <label class="form-label">Имя пользователя *</label>
                        <input type="text" class="form-control" id="createUsername" required>
                        <small class="text-muted">Используется для входа</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Пароль *</label>
                        <input type="password" class="form-control" id="createPassword" required>
                        <small class="text-muted">Минимум 8 символов</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Telegram ID (необязательно)</label>
                        <input type="number" class="form-control" id="createTelegramId">
                        <small class="text-muted">ID Telegram аккаунта администратора</small>
                    </div>
                    <div class="mb-3">
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="generatePassword()">
                            <i class="bi bi-key"></i> Сгенерировать безопасный пароль
                        </button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="createAdmin()">
                    <i class="bi bi-save"></i> Создать
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="passwordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Изменить пароль</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="passwordModalAdminName" class="alert alert-info mb-3"></div>
                <form id="passwordForm">
                    <input type="hidden" id="passwordAdminId">
                    <div class="mb-3">
                        <label class="form-label">Новый пароль *</label>
                        <input type="password" class="form-control" id="newPassword" required>
                        <small class="text-muted">Минимум 8 символов</small>
                    </div>
                    <div class="mb-3">
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="generatePasswordForChange()">
                            <i class="bi bi-key"></i> Сгенерировать безопасный пароль
                        </button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="changePassword()">
                    <i class="bi bi-save"></i> Изменить
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let createModal;
    let passwordModal;
    
    function generatePassword() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
        let password = '';
        for (let i = 0; i < 16; i++) {
            password += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        document.getElementById('createPassword').value = password;
        document.getElementById('createPassword').type = 'text';
        setTimeout(() => {
            document.getElementById('createPassword').type = 'password';
        }, 3000);
    }
    
    function generatePasswordForChange() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
        let password = '';
        for (let i = 0; i < 16; i++) {
            password += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        document.getElementById('newPassword').value = password;
        document.getElementById('newPassword').type = 'text';
        setTimeout(() => {
            document.getElementById('newPassword').type = 'password';
        }, 3000);
    }
    
    async function loadAdmins() {
        try {
            const response = await apiRequest('/api/admins');
            
            if (!response.ok) {
                if (response.status === 403) {
                    showAccessDeniedMessage();
                    return;
                }
                throw new Error('Failed to load admins');
            }
            
            const admins = await response.json();
            
            const container = document.getElementById('adminsTable');
            
            if (admins.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-shield-lock" style="font-size: 4rem; color: #dee2e6;"></i>
                        <p class="text-muted mt-3">Нет администраторов</p>
                    </div>
                `;
                return;
            }
            
            const tableHtml = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Имя пользователя</th>
                                <th>Telegram ID</th>
                                <th>Дата создания</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${admins.map(admin => `
                                <tr>
                                    <td>${admin.id}</td>
                                    <td>
                                        ${admin.username}
                                        ${admin.username === 'admin' ? '<span class="badge bg-danger ms-2">Главный</span>' : ''}
                                    </td>
                                    <td>${admin.telegram_id || '-'}</td>
                                    <td>${new Date(admin.created_at).toLocaleString('ru-RU')}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-warning me-1" onclick="openPasswordModal(${admin.id}, '${admin.username}')" title="Изменить пароль">
                                            <i class="bi bi-key"></i>
                                        </button>
                                        ${admin.username !== 'admin' ? 
                                            `<button class="btn btn-sm btn-outline-danger" onclick="deleteAdmin(${admin.id}, '${admin.username}')" title="Удалить">
                                                <i class="bi bi-trash"></i>
                                            </button>` : 
                                            '<span class="text-muted small">Защищен</span>'
                                        }
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHtml;
        } catch (error) {
            console.error('Error loading admins:', error);
            showToast('Ошибка при загрузке администраторов', 'error');
        }
    }
    
    function showAccessDeniedMessage() {
        const container = document.getElementById('adminsTable');
        container.innerHTML = `
            <div class="alert alert-danger" role="alert">
                <h4 class="alert-heading"><i class="bi bi-x-circle"></i> Доступ запрещен</h4>
                <p>Только главный администратор (admin) может управлять администраторами.</p>
                <hr>
                <p class="mb-0">Если вам нужен доступ, обратитесь к главному администратору.</p>
            </div>
        `;
    }
    
    function openCreateModal() {
        document.getElementById('createUsername').value = '';
        document.getElementById('createPassword').value = '';
        document.getElementById('createTelegramId').value = '';
        createModal.show();
    }
    
    function openPasswordModal(adminId, username) {
        document.getElementById('passwordAdminId').value = adminId;
        document.getElementById('newPassword').value = '';
        document.getElementById('passwordModalAdminName').innerHTML = `
            <strong>Администратор:</strong> ${username}
        `;
        passwordModal.show();
    }
    
    async function createAdmin() {
        const username = document.getElementById('createUsername').value.trim();
        const password = document.getElementById('createPassword').value;
        const telegramId = document.getElementById('createTelegramId').value.trim();
        
        if (!username) {
            alert('Пожалуйста, введите имя пользователя');
            return;
        }
        
        if (!password) {
            alert('Пожалуйста, введите пароль');
            return;
        }
        
        if (password.length < 8) {
            alert('Пароль должен быть минимум 8 символов');
            return;
        }
        
        try {
            const data = {
                username: username,
                password: password
            };
            
            if (telegramId) {
                data.telegram_id = parseInt(telegramId);
            }
            
            const response = await apiRequest('/api/admins', {
                method: 'POST',
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                const result = await response.json();
                createModal.hide();
                loadAdmins();
                showToast('Администратор успешно создан!', 'success');
                
                // Show credentials
                alert(`✅ Администратор создан!\n\nЛогин: ${username}\nПароль: ${password}\n\n⚠️ СОХРАНИТЕ ЭТИ ДАННЫЕ!`);
            } else {
                const error = await response.json();
                throw new Error(error.detail || 'Ошибка при создании администратора');
            }
        } catch (error) {
            console.error('Error creating admin:', error);
            alert('Ошибка: ' + error.message);
        }
    }
    
    async function changePassword() {
        const adminId = document.getElementById('passwordAdminId').value;
        const newPassword = document.getElementById('newPassword').value;
        
        if (!newPassword) {
            alert('Пожалуйста, введите новый пароль');
            return;
        }
        
        if (newPassword.length < 8) {
            alert('Пароль должен быть минимум 8 символов');
            return;
        }
        
        try {
            const response = await apiRequest(`/api/admins/${adminId}/password`, {
                method: 'PUT',
                body: JSON.stringify({ password: newPassword })
            });
            
            if (response.ok) {
                passwordModal.hide();
                showToast('Пароль успешно изменен!', 'success');
                alert(`✅ Пароль изменен!\n\nНовый пароль: ${newPassword}\n\n⚠️ СОХРАНИТЕ ЕГО!`);
            } else {
                const error = await response.json();
                throw new Error(error.detail || 'Ошибка при изменении пароля');
            }
        } catch (error) {
            console.error('Error changing password:', error);
            alert('Ошибка: ' + error.message);
        }
    }
    
    async function deleteAdmin(adminId, username) {
        if (!confirm(`Вы уверены, что хотите удалить администратора "${username}"?\n\nЭто действие необратимо!`)) {
            return;
        }
        
        try {
            const response = await apiRequest(`/api/admins/${adminId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                loadAdmins();
                showToast('Администратор удален', 'success');
            } else {
                const error = await response.json();
                throw new Error(error.detail || 'Ошибка при удалении администратора');
            }
        } catch (error) {
            console.error('Error deleting admin:', error);
            alert('Ошибка: ' + error.message);
        }
    }
    
    // Check authentication and initialize
    if (!getToken()) {
        window.location.href = '/';
    } else {
        createModal = new bootstrap.Modal(document.getElementById('createModal'));
        passwordModal = new bootstrap.Modal(document.getElementById('passwordModal'));
        loadAdmins();
    }
</script>
{% endblock %}

