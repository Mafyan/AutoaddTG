{% extends "base.html" %}

{% block title %}Чаты{% endblock %}

{% block content %}
<div class="sidebar">
    <div class="brand">
        <i class="bi bi-robot"></i> User Control
    </div>
    <nav class="nav flex-column">
        <a class="nav-link" href="/dashboard">
            <i class="bi bi-speedometer2"></i> Панель управления
        </a>
        <a class="nav-link" href="/requests">
            <i class="bi bi-person-check"></i> Заявки
        </a>
        <a class="nav-link" href="/users">
            <i class="bi bi-people"></i> Пользователи
        </a>
        <a class="nav-link" href="/roles">
            <i class="bi bi-person-badge"></i> Роли
        </a>
        <a class="nav-link active" href="/chats">
            <i class="bi bi-chat-dots"></i> Чаты
        </a>
        <hr style="border-color: rgba(255,255,255,0.2);">
        <a class="nav-link" href="#" onclick="logout()">
            <i class="bi bi-box-arrow-right"></i> Выход
        </a>
    </nav>
</div>

<div class="main-content">
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="h2 fw-bold mb-0">Чаты</h1>
            <div class="d-flex gap-2">
                <button class="btn btn-primary" onclick="openCreateModal()">
                    <i class="bi bi-plus-lg"></i> Добавить чат
                </button>
                <button class="btn btn-outline-secondary" onclick="loadChats()">
                    <i class="bi bi-arrow-clockwise"></i> Обновить
                </button>
            </div>
        </div>
        
        <!-- Actions Row -->
        <div class="d-flex flex-wrap gap-2">
            <div class="btn-group" role="group">
                <button class="btn btn-success" onclick="syncChats()">
                    <i class="bi bi-robot"></i> Синхронизировать чаты
                </button>
                <button class="btn btn-warning" onclick="syncMembers()">
                    <i class="bi bi-people"></i> Синхронизировать участников
                </button>
            </div>
            
            <div class="btn-group" role="group">
                <button class="btn btn-info" onclick="startAutoSync()">
                    <i class="bi bi-play-circle"></i> Запустить авто-синхронизацию
                </button>
                <button class="btn btn-danger" onclick="stopAutoSync()">
                    <i class="bi bi-stop-circle"></i> Остановить авто-синхронизацию
                </button>
            </div>
            
            <button class="btn btn-secondary" onclick="forceRefreshMembers()">
                <i class="bi bi-arrow-clockwise"></i> Обновить участников чата
            </button>
        </div>
    </div>
    
    <div class="table-container">
        <div id="chatsTable">
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Загрузка...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Chat Modal -->
<div class="modal fade" id="chatModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="chatModalTitle">Добавить чат</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="chatForm">
                    <input type="hidden" id="chatId">
                    <div class="mb-3">
                        <label class="form-label">Название чата</label>
                        <input type="text" class="form-control" id="chatName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ссылка на чат</label>
                        <input type="text" class="form-control" id="chatLink" placeholder="https://t.me/...">
                        <small class="text-muted">Инвайт-ссылка на Telegram чат</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Chat ID (необязательно)</label>
                        <input type="number" class="form-control" id="chatTgId" placeholder="-100...">
                        <small class="text-muted">Telegram Chat ID (если известен)</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Описание</label>
                        <textarea class="form-control" id="chatDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="saveChat()">
                    <i class="bi bi-save"></i> Сохранить
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Upload Photo Modal -->
<div class="modal fade" id="photoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Изменить фото чата</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="photoModalChatName" class="alert alert-info mb-3"></div>
                <input type="hidden" id="photoChatId">
                <input type="hidden" id="photoTelegramChatId">
                
                <div class="mb-3">
                    <label class="form-label">Выберите фото</label>
                    <input type="file" class="form-control" id="chatPhotoInput" accept="image/jpeg,image/png,image/jpg">
                    <small class="text-muted">Только JPG/PNG файлы. Рекомендуемый размер: квадратное изображение</small>
                </div>
                
                <div id="photoPreview" class="text-center mb-3" style="display: none;">
                    <img id="photoPreviewImg" src="" alt="Preview" class="img-thumbnail" style="max-width: 300px; max-height: 300px;">
                </div>
                
                <div id="uploadProgress" class="mb-3" style="display: none;">
                    <div class="progress">
                        <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    <small id="uploadStatus" class="text-muted"></small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="uploadPhotoBtn" onclick="uploadChatPhoto()">
                    <i class="bi bi-upload"></i> Загрузить и установить
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let chatModal;
    
    async function syncChats() {
        if (!confirm('Синхронизировать чаты с ботом? Это обновит список чатов, где находится бот.')) {
            return;
        }
        
        const button = document.querySelector('button[onclick="syncChats()"]');
        setButtonLoading(button, true);
        
        try {
            
            const response = await apiRequest('/api/chats/sync', {
                method: 'POST'
            });
            
            if (response.ok) {
                const result = await response.json();
                showToast(`Синхронизация завершена! Найдено: ${result.results.total_found}, Создано: ${result.results.created}, Обновлено: ${result.results.updated}`, 'success');
                loadChats(); // Reload the table
            } else {
                const error = await response.json();
                showToast('Ошибка синхронизации: ' + error.detail, 'error');
            }
        } catch (error) {
            console.error('Error syncing chats:', error);
            showToast('Ошибка при синхронизации чатов', 'error');
        } finally {
            setButtonLoading(button, false);
        }
    }
    
    async function syncMembers() {
        if (!confirm('Синхронизировать участников всех чатов? Это удалит неавторизованных пользователей.')) {
            return;
        }
        
        const button = document.querySelector('button[onclick="syncMembers()"]');
        setButtonLoading(button, true);
        
        try {
            const response = await apiRequest('/api/chats/sync-members', {
                method: 'POST'
            });
            
            if (response.ok) {
                showToast('Синхронизация участников завершена!', 'success');
            } else {
                const error = await response.json();
                showToast('Ошибка синхронизации: ' + error.detail, 'error');
            }
        } catch (error) {
            console.error('Error syncing members:', error);
            showToast('Ошибка при синхронизации участников', 'error');
        } finally {
            setButtonLoading(button, false);
        }
    }
    
    async function startAutoSync() {
        if (!confirm('Запустить автоматическую синхронизацию участников каждый час?')) {
            return;
        }
        
        const button = document.querySelector('button[onclick="startAutoSync()"]');
        setButtonLoading(button, true);
        
        try {
            const response = await apiRequest('/api/chats/start-auto-sync', {
                method: 'POST'
            });
            
            if (response.ok) {
                showToast('Автоматическая синхронизация запущена!', 'success');
            } else {
                const error = await response.json();
                showToast('Ошибка запуска: ' + error.detail, 'error');
            }
        } catch (error) {
            console.error('Error starting auto sync:', error);
            showToast('Ошибка при запуске автосинхронизации', 'error');
        } finally {
            setButtonLoading(button, false);
        }
    }
    
    async function stopAutoSync() {
        if (!confirm('Остановить автоматическую синхронизацию?')) {
            return;
        }
        
        const button = document.querySelector('button[onclick="stopAutoSync()"]');
        setButtonLoading(button, true);
        
        try {
            const response = await apiRequest('/api/chats/stop-auto-sync', {
                method: 'POST'
            });
            
            if (response.ok) {
                showToast('Автоматическая синхронизация остановлена!', 'info');
            } else {
                const error = await response.json();
                showToast('Ошибка остановки: ' + error.detail, 'error');
            }
        } catch (error) {
            console.error('Error stopping auto sync:', error);
            showToast('Ошибка при остановке автосинхронизации', 'error');
        } finally {
            setButtonLoading(button, false);
        }
    }
    
    async function forceRefreshMembers() {
        // Get chat ID from user input
        const chatId = prompt('Введите Chat ID для принудительного обновления участников:');
        if (!chatId) {
            return;
        }
        
        const button = document.querySelector('button[onclick="forceRefreshMembers()"]');
        setButtonLoading(button, true);
        
        try {
            const response = await apiRequest(`/api/chats/force-refresh-members?chat_id=${chatId}`, {
                method: 'POST'
            });
            
            if (response.ok) {
                const result = await response.json();
                showToast(`Найдено ${result.members.length} участников в чате ${chatId}`, 'success');
                
                // Show members list in console
                console.log('Участники чата:', result.members);
                
                // Show summary in toast
                if (result.members.length > 0) {
                    console.table(result.members.map(m => ({
                        ID: m.id,
                        Имя: m.first_name,
                        Username: m.username ? '@' + m.username : '-',
                        Admin: m.is_admin ? 'Да' : 'Нет'
                    })));
                }
            } else {
                const error = await response.json();
                showToast('Ошибка обновления: ' + error.detail, 'error');
            }
        } catch (error) {
            console.error('Error refreshing members:', error);
            showToast('Ошибка при обновлении участников', 'error');
        } finally {
            setButtonLoading(button, false);
        }
    }
    
    async function loadChats() {
        try {
            const response = await apiRequest('/api/chats');
            const chats = await response.json();
            
            const container = document.getElementById('chatsTable');
            
            if (chats.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-chat-dots" style="font-size: 4rem; color: #dee2e6;"></i>
                        <p class="text-muted mt-3">Нет чатов</p>
                    </div>
                `;
                return;
            }
            
            const tableHtml = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Название</th>
                                <th>Ссылка</th>
                                <th>Chat ID</th>
                                <th>Описание</th>
                                <th>Привязанные роли</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${chats.map(chat => `
                                <tr>
                                    <td>${chat.id}</td>
                                    <td>${chat.chat_name}</td>
                                    <td>
                                        ${chat.chat_link ? 
                                            `<a href="${chat.chat_link}" target="_blank" class="text-decoration-none">
                                                <i class="bi bi-link-45deg"></i> Ссылка
                                            </a>` : 
                                            '-'}
                                    </td>
                                    <td><code>${chat.chat_id || '-'}</code></td>
                                    <td>${chat.description || '-'}</td>
                                    <td>
                                        ${chat.roles.length > 0 ? 
                                            chat.roles.map(role => 
                                                `<span class="badge bg-secondary me-1">${role.name}</span>`
                                            ).join('') : 
                                            '<span class="text-muted">-</span>'}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary me-1" onclick='openEditModal(${JSON.stringify(chat).replace(/'/g, "&apos;")})'>
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        ${chat.chat_id ? 
                                            `<button class="btn btn-sm btn-outline-info me-1" onclick="openPhotoModal(${chat.id}, ${chat.chat_id}, '${chat.chat_name}')" title="Изменить фото">
                                                <i class="bi bi-image"></i>
                                            </button>` : ''}
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteChat(${chat.id})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHtml;
        } catch (error) {
            console.error('Error loading chats:', error);
        }
    }
    
    function openCreateModal() {
        document.getElementById('chatModalTitle').textContent = 'Добавить чат';
        document.getElementById('chatId').value = '';
        document.getElementById('chatName').value = '';
        document.getElementById('chatLink').value = '';
        document.getElementById('chatTgId').value = '';
        document.getElementById('chatDescription').value = '';
        chatModal.show();
    }
    
    function openEditModal(chat) {
        document.getElementById('chatModalTitle').textContent = 'Редактировать чат';
        document.getElementById('chatId').value = chat.id;
        document.getElementById('chatName').value = chat.chat_name;
        document.getElementById('chatLink').value = chat.chat_link || '';
        document.getElementById('chatTgId').value = chat.chat_id || '';
        document.getElementById('chatDescription').value = chat.description || '';
        chatModal.show();
    }
    
    async function saveChat() {
        const chatId = document.getElementById('chatId').value;
        const name = document.getElementById('chatName').value.trim();
        const link = document.getElementById('chatLink').value.trim();
        const tgId = document.getElementById('chatTgId').value.trim();
        const description = document.getElementById('chatDescription').value.trim();
        
        if (!name) {
            alert('Пожалуйста, введите название чата');
            return;
        }
        
        try {
            const data = {
                chat_name: name,
                chat_link: link || null,
                chat_id: tgId ? parseInt(tgId) : null,
                description: description || null
            };
            
            let response;
            if (chatId) {
                // Update existing chat
                response = await apiRequest(`/api/chats/${chatId}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
            } else {
                // Create new chat
                response = await apiRequest('/api/chats', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
            }
            
            if (response.ok) {
                chatModal.hide();
                loadChats();
                alert(chatId ? 'Чат обновлен!' : 'Чат добавлен!');
            }
        } catch (error) {
            console.error('Error saving chat:', error);
            alert('Ошибка при сохранении чата');
        }
    }
    
    async function deleteChat(chatId) {
        if (!confirm('Вы уверены, что хотите удалить этот чат?')) {
            return;
        }
        
        try {
            const response = await apiRequest(`/api/chats/${chatId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                loadChats();
                alert('Чат удален');
            }
        } catch (error) {
            console.error('Error deleting chat:', error);
            alert('Ошибка при удалении чата');
        }
    }
    
    // Photo Upload Functions
    let photoModal;
    
    function openPhotoModal(chatId, telegramChatId, chatName) {
        document.getElementById('photoChatId').value = chatId;
        document.getElementById('photoTelegramChatId').value = telegramChatId;
        document.getElementById('photoModalChatName').innerHTML = `<strong>Чат:</strong> ${chatName}<br><strong>Chat ID:</strong> <code>${telegramChatId}</code>`;
        
        // Reset file input and preview
        document.getElementById('chatPhotoInput').value = '';
        document.getElementById('photoPreview').style.display = 'none';
        document.getElementById('uploadProgress').style.display = 'none';
        
        photoModal.show();
    }
    
    // Preview photo before upload
    document.addEventListener('DOMContentLoaded', function() {
        const photoInput = document.getElementById('chatPhotoInput');
        if (photoInput) {
            photoInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        document.getElementById('photoPreviewImg').src = event.target.result;
                        document.getElementById('photoPreview').style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
    });
    
    async function uploadChatPhoto() {
        const chatId = document.getElementById('photoChatId').value;
        const fileInput = document.getElementById('chatPhotoInput');
        const uploadBtn = document.getElementById('uploadPhotoBtn');
        
        if (!fileInput.files || !fileInput.files[0]) {
            alert('Пожалуйста, выберите файл');
            return;
        }
        
        const file = fileInput.files[0];
        
        // Validate file type
        if (!file.type.startsWith('image/')) {
            alert('Пожалуйста, выберите изображение (JPG/PNG)');
            return;
        }
        
        // Validate file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('Файл слишком большой. Максимальный размер: 5MB');
            return;
        }
        
        try {
            // Disable button
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Загрузка...';
            
            // Show progress
            document.getElementById('uploadProgress').style.display = 'block';
            document.getElementById('uploadProgressBar').style.width = '30%';
            document.getElementById('uploadStatus').textContent = 'Загрузка файла...';
            
            // Create FormData
            const formData = new FormData();
            formData.append('photo', file);
            
            // Upload photo
            const response = await fetch(`/api/chats/${chatId}/upload-photo`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${getToken()}`
                },
                body: formData
            });
            
            document.getElementById('uploadProgressBar').style.width = '70%';
            document.getElementById('uploadStatus').textContent = 'Устанавливаем фото в Telegram...';
            
            if (response.ok) {
                const result = await response.json();
                
                document.getElementById('uploadProgressBar').style.width = '100%';
                document.getElementById('uploadStatus').textContent = 'Готово!';
                
                showToast('Фото чата успешно обновлено!', 'success');
                
                setTimeout(() => {
                    photoModal.hide();
                    loadChats();
                }, 1000);
            } else {
                const error = await response.json();
                throw new Error(error.detail || 'Ошибка при загрузке фото');
            }
        } catch (error) {
            console.error('Error uploading photo:', error);
            showToast(error.message || 'Ошибка при загрузке фото чата', 'error');
            
            document.getElementById('uploadProgressBar').style.width = '0%';
            document.getElementById('uploadStatus').textContent = '';
        } finally {
            // Re-enable button
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<i class="bi bi-upload"></i> Загрузить и установить';
        }
    }
    
    // Check authentication and initialize
    if (!getToken()) {
        window.location.href = '/';
    } else {
        chatModal = new bootstrap.Modal(document.getElementById('chatModal'));
        photoModal = new bootstrap.Modal(document.getElementById('photoModal'));
        loadChats();
    }
</script>
{% endblock %}

