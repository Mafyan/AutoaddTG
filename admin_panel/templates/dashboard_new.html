{% extends "base_new.html" %}

{% block title %}Панель управления{% endblock %}

{% block content %}
<!-- Sidebar -->
<aside class="sidebar" id="sidebar" role="navigation" aria-label="Главное меню">
    <div class="sidebar-brand" href="/dashboard">
        <i class="bi bi-robot sidebar-brand-icon"></i>
        <span>User Control</span>
    </div>
    
    <nav class="sidebar-nav">
        <a class="sidebar-nav-link active" href="/dashboard" aria-current="page">
            <i class="bi bi-speedometer2 sidebar-nav-icon"></i>
            <span>Панель управления</span>
        </a>
        <a class="sidebar-nav-link" href="/requests">
            <i class="bi bi-person-check sidebar-nav-icon"></i>
            <span>Заявки</span>
        </a>
        <a class="sidebar-nav-link" href="/users">
            <i class="bi bi-people sidebar-nav-icon"></i>
            <span>Пользователи</span>
        </a>
        <a class="sidebar-nav-link" href="/role-groups">
            <i class="bi bi-collection sidebar-nav-icon"></i>
            <span>Группы ролей</span>
        </a>
        <a class="sidebar-nav-link" href="/roles">
            <i class="bi bi-person-badge sidebar-nav-icon"></i>
            <span>Роли</span>
        </a>
        <a class="sidebar-nav-link" href="/chats">
            <i class="bi bi-chat-dots sidebar-nav-icon"></i>
            <span>Чаты</span>
        </a>
    </nav>
    
    <div class="sidebar-footer">
        <a class="sidebar-footer-link" href="#" onclick="logout(); return false;" role="button">
            <i class="bi bi-box-arrow-right sidebar-nav-icon"></i>
            <span>Выход</span>
        </a>
    </div>
</aside>

<!-- Main Content -->
<main class="main-content">
    <!-- Page Header -->
    <header class="page-header">
        <div>
            <h1 class="page-title">Панель управления</h1>
            <p class="page-subtitle" id="welcomeMessage">Добро пожаловать!</p>
        </div>
        <div class="page-actions">
            <button class="btn btn-outline" onclick="loadStats()" aria-label="Обновить статистику">
                <i class="bi bi-arrow-clockwise"></i>
                <span>Обновить</span>
            </button>
        </div>
    </header>
    
    <!-- Stats Section -->
    <section class="content-section" aria-labelledby="stats-title">
        <h2 id="stats-title" class="sr-only">Статистика</h2>
        <div class="grid-auto" id="statsContainer">
            <!-- Loading skeleton -->
            <div class="stat-card">
                <div class="skeleton" style="width: 48px; height: 48px; border-radius: 12px;"></div>
                <div class="skeleton" style="width: 100px; height: 40px; margin-top: 16px;"></div>
                <div class="skeleton" style="width: 150px; height: 20px;"></div>
            </div>
            <div class="stat-card">
                <div class="skeleton" style="width: 48px; height: 48px; border-radius: 12px;"></div>
                <div class="skeleton" style="width: 100px; height: 40px; margin-top: 16px;"></div>
                <div class="skeleton" style="width: 150px; height: 20px;"></div>
            </div>
            <div class="stat-card">
                <div class="skeleton" style="width: 48px; height: 48px; border-radius: 12px;"></div>
                <div class="skeleton" style="width: 100px; height: 40px; margin-top: 16px;"></div>
                <div class="skeleton" style="width: 150px; height: 20px;"></div>
            </div>
            <div class="stat-card">
                <div class="skeleton" style="width: 48px; height: 48px; border-radius: 12px;"></div>
                <div class="skeleton" style="width: 100px; height: 40px; margin-top: 16px;"></div>
                <div class="skeleton" style="width: 150px; height: 20px;"></div>
            </div>
        </div>
    </section>
    
    <!-- Recent Requests Section -->
    <section class="content-section" aria-labelledby="recent-title">
        <div class="section-header">
            <div>
                <h2 class="section-title" id="recent-title">Последние заявки</h2>
                <p class="section-description">Новые пользователи ожидающие одобрения</p>
            </div>
        </div>
        
        <div class="table-container">
            <div id="recentRequests" role="region" aria-live="polite" aria-busy="true">
                <!-- Loading spinner -->
                <div style="text-align: center; padding: 60px 20px;">
                    <div class="spinner" style="margin: 0 auto;"></div>
                    <p style="margin-top: 20px; color: var(--text-secondary);">Загрузка данных...</p>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Quick Actions -->
    <section class="content-section" aria-labelledby="actions-title">
        <div class="section-header">
            <h2 class="section-title" id="actions-title">Быстрые действия</h2>
        </div>
        
        <div class="grid-3">
            <div class="card card-hover">
                <div class="card-header">
                    <i class="bi bi-person-check" style="font-size: 2rem; color: var(--success);"></i>
                </div>
                <h3 class="card-title" style="font-size: var(--text-lg); margin-top: var(--space-3);">Обработать заявки</h3>
                <p class="card-description">Просмотрите и одобрите новых пользователей</p>
                <div class="card-footer">
                    <a href="/requests" class="btn btn-primary" style="width: 100%;">
                        Перейти к заявкам
                        <i class="bi bi-arrow-right"></i>
                    </a>
                </div>
            </div>
            
            <div class="card card-hover">
                <div class="card-header">
                    <i class="bi bi-people" style="font-size: 2rem; color: var(--info);"></i>
                </div>
                <h3 class="card-title" style="font-size: var(--text-lg); margin-top: var(--space-3);">Управление пользователями</h3>
                <p class="card-description">Просмотр, редактирование и управление пользователями</p>
                <div class="card-footer">
                    <a href="/users" class="btn btn-primary" style="width: 100%;">
                        К пользователям
                        <i class="bi bi-arrow-right"></i>
                    </a>
                </div>
            </div>
            
            <div class="card card-hover">
                <div class="card-header">
                    <i class="bi bi-chat-dots" style="font-size: 2rem; color: var(--brand-secondary);"></i>
                </div>
                <h3 class="card-title" style="font-size: var(--text-lg); margin-top: var(--space-3);">Настройка чатов</h3>
                <p class="card-description">Управление чатами и синхронизация участников</p>
                <div class="card-footer">
                    <a href="/chats" class="btn btn-primary" style="width: 100%;">
                        К чатам
                        <i class="bi bi-arrow-right"></i>
                    </a>
                </div>
            </div>
        </div>
    </section>
</main>
{% endblock %}

{% block extra_js %}
<script>
    // Load statistics
    async function loadStats() {
        const container = document.getElementById('statsContainer');
        
        try {
            const response = await apiRequest('/api/stats');
            
            if (!response.ok) {
                throw new Error('Failed to load statistics');
            }
            
            const data = await response.json();
            
            // Create stats cards with modern design
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-card-icon" style="background: #e0f2fe; color: #0284c7;">
                        <i class="bi bi-people"></i>
                    </div>
                    <div class="stat-card-value">${data.total_users.toLocaleString('ru-RU')}</div>
                    <div class="stat-card-label">Всего пользователей</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-card-icon" style="background: #fef3c7; color: #d97706;">
                        <i class="bi bi-hourglass-split"></i>
                    </div>
                    <div class="stat-card-value">${data.pending_requests.toLocaleString('ru-RU')}</div>
                    <div class="stat-card-label">Ожидают одобрения</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-card-icon" style="background: #d1fae5; color: #047857;">
                        <i class="bi bi-check-circle"></i>
                    </div>
                    <div class="stat-card-value">${data.approved_users.toLocaleString('ru-RU')}</div>
                    <div class="stat-card-label">Одобрено</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-card-icon" style="background: #fee2e2; color: #dc2626;">
                        <i class="bi bi-x-circle"></i>
                    </div>
                    <div class="stat-card-value">${data.rejected_users.toLocaleString('ru-RU')}</div>
                    <div class="stat-card-label">Отклонено</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-card-icon" style="background: #fce7f3; color: #be123c;">
                        <i class="bi bi-person-x"></i>
                    </div>
                    <div class="stat-card-value">${(data.fired_users || 0).toLocaleString('ru-RU')}</div>
                    <div class="stat-card-label">Уволено</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-card-icon" style="background: #f3e8ff; color: #7c3aed;">
                        <i class="bi bi-person-badge"></i>
                    </div>
                    <div class="stat-card-value">${data.total_roles.toLocaleString('ru-RU')}</div>
                    <div class="stat-card-label">Ролей</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-card-icon" style="background: #e0f2f1; color: #00796b;">
                        <i class="bi bi-chat-dots"></i>
                    </div>
                    <div class="stat-card-value">${data.total_chats.toLocaleString('ru-RU')}</div>
                    <div class="stat-card-label">Чатов</div>
                </div>
            `;
        } catch (error) {
            console.error('Error loading stats:', error);
            showToast('Ошибка при загрузке статистики', 'error');
            
            container.innerHTML = `
                <div class="empty-state" style="grid-column: 1 / -1;">
                    <i class="bi bi-exclamation-triangle empty-state-icon"></i>
                    <h3 class="empty-state-title">Не удалось загрузить статистику</h3>
                    <p class="empty-state-description">Произошла ошибка при загрузке данных. Попробуйте обновить страницу.</p>
                    <button class="btn btn-primary" onclick="loadStats()">
                        <i class="bi bi-arrow-clockwise"></i>
                        Попробовать снова
                    </button>
                </div>
            `;
        }
    }
    
    // Load recent requests
    async function loadRecentRequests() {
        const container = document.getElementById('recentRequests');
        container.setAttribute('aria-busy', 'true');
        
        try {
            const response = await apiRequest('/api/users?status=pending');
            
            if (!response.ok) {
                throw new Error('Failed to load requests');
            }
            
            const users = await response.json();
            container.setAttribute('aria-busy', 'false');
            
            if (users.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-inbox empty-state-icon"></i>
                        <h3 class="empty-state-title">Нет новых заявок</h3>
                        <p class="empty-state-description">Все заявки обработаны. Новые заявки появятся здесь автоматически.</p>
                    </div>
                `;
                return;
            }
            
            // Show only first 5 requests
            const recentUsers = users.slice(0, 5);
            
            container.innerHTML = `
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Имя</th>
                                <th>Телефон</th>
                                <th>Username</th>
                                <th>Дата</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${recentUsers.map(user => `
                                <tr>
                                    <td><strong>${user.id}</strong></td>
                                    <td>${escapeHtml(user.first_name || '')} ${escapeHtml(user.last_name || '')}</td>
                                    <td>${escapeHtml(user.phone_number)}</td>
                                    <td>${user.username ? '@' + escapeHtml(user.username) : '-'}</td>
                                    <td>${new Date(user.created_at).toLocaleString('ru-RU', { 
                                        year: 'numeric', 
                                        month: 'short', 
                                        day: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    })}</td>
                                    <td>
                                        <a href="/requests" class="btn btn-sm btn-primary">
                                            Обработать
                                        </a>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ${users.length > 5 ? `
                    <div style="text-align: center; padding-top: var(--space-4); border-top: 1px solid var(--border);">
                        <a href="/requests" class="btn btn-outline">
                            Показать все заявки (${users.length})
                            <i class="bi bi-arrow-right"></i>
                        </a>
                    </div>
                ` : ''}
            `;
        } catch (error) {
            console.error('Error loading recent requests:', error);
            container.setAttribute('aria-busy', 'false');
            
            container.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-exclamation-triangle empty-state-icon"></i>
                    <h3 class="empty-state-title">Ошибка загрузки</h3>
                    <p class="empty-state-description">Не удалось загрузить последние заявки.</p>
                    <button class="btn btn-primary" onclick="loadRecentRequests()">
                        <i class="bi bi-arrow-clockwise"></i>
                        Попробовать снова
                    </button>
                </div>
            `;
        }
    }
    
    // Helper function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Check authentication and load data
    if (!getToken()) {
        window.location.href = '/';
    } else {
        // Set welcome message with current time
        const hour = new Date().getHours();
        let greeting = 'Добрый день';
        if (hour < 12) greeting = 'Доброе утро';
        if (hour >= 18) greeting = 'Добрый вечер';
        document.getElementById('welcomeMessage').textContent = greeting + '!';
        
        // Load data
        loadStats();
        loadRecentRequests();
        
        // Auto-refresh every 30 seconds
        setInterval(() => {
            loadStats();
            loadRecentRequests();
        }, 30000);
    }
</script>
{% endblock %}

